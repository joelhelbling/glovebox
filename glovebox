#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IMAGE_NAME="glovebox"

show_usage() {
    cat << 'EOF'
glovebox - Run code in an isolated Docker environment

USAGE:
    glovebox [OPTIONS] [DIRECTORY]
    glovebox clone <repository> [OPTIONS]

ARGUMENTS:
    DIRECTORY    Path to mount as workspace (default: current directory)

COMMANDS:
    clone <repository>
        Clone a git repository and start glovebox in it.
        Repository can be:
          - user/repo    (assumes GitHub, e.g., joelhelbling/glovebox)
          - Full URL     (GitHub, GitLab, Bitbucket, or any git URL)

        If a directory named 'clone' exists and no repository is specified,
        you will be prompted to clarify your intent.

OPTIONS:
    -h, --help   Show this help message and exit
    --build      Force rebuild of the Docker image before running

DESCRIPTION:
    Glovebox creates a sandboxed Docker container for running untrusted or
    experimental code. It mounts your specified directory into the container
    and sets up a persistent mise volume for tool installations.

    Each unique directory path gets its own mise volume, so tool installations
    are cached between sessions for the same project.

ENVIRONMENT VARIABLES:
    The following environment variables are passed into the container if set:
        ANTHROPIC_API_KEY
        OPENAI_API_KEY
        GOOGLE_API_KEY
        GEMINI_API_KEY

EXAMPLES:
    glovebox                    # Run in current directory
    glovebox ~/projects/myapp   # Run with specific directory
    glovebox --build            # Rebuild image, then run in current directory
    glovebox --build ./myapp    # Rebuild image, then run with ./myapp
    glovebox clone rails/rails  # Clone from GitHub and run glovebox in it
    glovebox clone https://gitlab.com/user/repo.git  # Clone from any git URL

EOF
}

# Handle help flag
if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    show_usage
    exit 0
fi

# Handle clone command
if [[ "$1" == "clone" ]]; then
    # Check for ambiguity: no repo argument AND a directory named "clone" exists
    if [[ -z "$2" ]] && [[ -d "clone" ]]; then
        echo "Ambiguous: 'clone' could be a command or a directory."
        echo "Did you mean:"
        echo "  1) Clone a repository (requires: glovebox clone <user/repo>)"
        echo "  2) Open directory ./clone"
        echo ""
        read -p "Enter choice [1/2]: " choice
        case "$choice" in
            1)
                echo "Error: clone command requires a repository argument"
                echo "Usage: glovebox clone <user/repo> or glovebox clone <url>"
                exit 1
                ;;
            2)
                # Treat as directory, let it fall through to normal processing
                :
                ;;
            *)
                echo "Invalid choice. Exiting."
                exit 1
                ;;
        esac
    elif [[ -z "$2" ]]; then
        # No directory conflict, just missing argument
        echo "Error: clone requires a repository argument"
        echo "Usage: glovebox clone <user/repo> or glovebox clone <url>"
        exit 1
    else
        # Clone command with repo argument - execute it
        REPO_ARG="$2"
        shift 2  # Remove 'clone' and repo from args, remaining args passed to glovebox

        # Convert user/repo format to GitHub URL if it doesn't look like a URL
        if [[ "$REPO_ARG" != *"://"* && "$REPO_ARG" != *"@"* ]]; then
            # Assume GitHub for short form (user/repo)
            REPO_URL="https://github.com/${REPO_ARG}.git"
        else
            REPO_URL="$REPO_ARG"
        fi

        # Extract directory name from URL
        CLONE_DIR=$(basename "$REPO_URL" .git)

        echo "Cloning $REPO_URL..."
        if ! git clone "$REPO_URL"; then
            echo "Error: Failed to clone repository"
            exit 1
        fi

        echo "Entering $CLONE_DIR and starting glovebox..."
        cd "$CLONE_DIR"

        # Re-invoke glovebox in the cloned directory with any remaining args
        exec "$SCRIPT_DIR/glovebox" "$@" .
    fi
fi

# Build the image if it doesn't exist or if --build flag is passed
if [[ "$1" == "--build" ]] || [[ "$2" == "--build" ]]; then
    echo "Building glovebox image..."
    docker build -t "$IMAGE_NAME" "$SCRIPT_DIR"
    # Remove --build from args
    args=("$@")
    for i in "${!args[@]}"; do
        if [[ "${args[$i]}" == "--build" ]]; then
            unset 'args[$i]'
        fi
    done
    set -- "${args[@]}"
fi

# Check if image exists
if ! docker image inspect "$IMAGE_NAME" &> /dev/null; then
    echo "Glovebox image not found. Building..."
    docker build -t "$IMAGE_NAME" "$SCRIPT_DIR"
fi

# Default to current directory if no path provided
TARGET_DIR="${1:-.}"

# Resolve to absolute path
TARGET_DIR="$(cd "$TARGET_DIR" && pwd)"

# Extract the directory name for use as the container workspace name
DIR_NAME="$(basename "$TARGET_DIR")"
CONTAINER_PATH="/home/ubuntu/$DIR_NAME"

# Generate a unique volume name: glovebox-<basename>-<short-hash>
SHORT_HASH=$(echo -n "$TARGET_DIR" | shasum -a 256 | cut -c1-7)
VOLUME_NAME="glovebox-${DIR_NAME}-${SHORT_HASH}"

# Create the volume if it doesn't exist
if ! docker volume inspect "$VOLUME_NAME" &> /dev/null; then
    echo "Creating mise volume: $VOLUME_NAME"
    docker volume create "$VOLUME_NAME" > /dev/null
fi

echo "Starting glovebox with workspace: $TARGET_DIR -> $CONTAINER_PATH"
echo "Using mise volume: $VOLUME_NAME"

docker run -it --rm \
    -v "$TARGET_DIR:$CONTAINER_PATH" \
    -w "$CONTAINER_PATH" \
    -v "$VOLUME_NAME:/home/ubuntu/.local/share/mise" \
    -v "$HOME/.anthropic:/home/ubuntu/.anthropic" \
    -v "$HOME/.config/gemini:/home/ubuntu/.config/gemini" \
    -e ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}" \
    -e OPENAI_API_KEY="${OPENAI_API_KEY:-}" \
    -e GOOGLE_API_KEY="${GOOGLE_API_KEY:-}" \
    -e GEMINI_API_KEY="${GEMINI_API_KEY:-}" \
    -e MISE_TRUSTED_CONFIG_PATHS="$CONTAINER_PATH:$CONTAINER_PATH/**" \
    --hostname glovebox \
    "$IMAGE_NAME"
