package generator

import (
	"fmt"
	"strings"

	"github.com/joelhelbling/glovebox/internal/snippet"
)

// Generate creates a Dockerfile from a list of snippet IDs
func Generate(snippetIDs []string) (string, error) {
	snippets, err := snippet.LoadMultiple(snippetIDs)
	if err != nil {
		return "", fmt.Errorf("loading snippets: %w", err)
	}

	var b strings.Builder

	// Header
	b.WriteString("# Generated by glovebox - DO NOT EDIT DIRECTLY\n")
	b.WriteString("#\n")
	b.WriteString("# To modify:\n")
	b.WriteString("#   glovebox add <snippet>      Add a snippet\n")
	b.WriteString("#   glovebox remove <snippet>   Remove a snippet\n")
	b.WriteString("#   glovebox build              Regenerate this file\n")
	b.WriteString("#\n")
	b.WriteString("# Snippets included:\n")
	for _, s := range snippets {
		b.WriteString(fmt.Sprintf("#   - %s\n", s.Name))
	}
	b.WriteString("\n")

	// Base image
	b.WriteString("FROM ubuntu:24.04\n\n")

	// Avoid interactive prompts
	b.WriteString("# Avoid interactive prompts during package installation\n")
	b.WriteString("ENV DEBIAN_FRONTEND=noninteractive\n\n")

	// Collect and dedupe apt repos
	aptRepos := collectAptRepos(snippets)
	if len(aptRepos) > 0 {
		b.WriteString("# Add APT repositories\n")
		b.WriteString("RUN ")
		for i, repo := range aptRepos {
			if i > 0 {
				b.WriteString(" && \\\n    ")
			}
			b.WriteString(fmt.Sprintf("apt-add-repository %s", repo))
		}
		b.WriteString("\n\n")
	}

	// Collect and dedupe apt packages
	aptPackages := collectAptPackages(snippets)
	if len(aptPackages) > 0 {
		b.WriteString("# Install packages\n")
		b.WriteString("RUN apt-get update && apt-get install -y \\\n")
		for i, pkg := range aptPackages {
			b.WriteString(fmt.Sprintf("    %s", pkg))
			if i < len(aptPackages)-1 {
				b.WriteString(" \\\n")
			} else {
				b.WriteString(" \\\n    && rm -rf /var/lib/apt/lists/*\n")
			}
		}
		b.WriteString("\n")
	}

	// Run as root commands (in snippet order)
	for _, s := range snippets {
		if s.RunAsRoot != "" {
			b.WriteString(fmt.Sprintf("# %s setup (root)\n", s.Name))
			// Use heredoc syntax for complex shell scripts
			b.WriteString("RUN <<'EOF'\n")
			b.WriteString("set -e\n")
			b.WriteString(strings.TrimSpace(s.RunAsRoot))
			b.WriteString("\nEOF\n\n")
		}
	}

	// Copy entrypoint
	b.WriteString("# Copy and set up entrypoint script\n")
	b.WriteString("COPY entrypoint.sh /usr/local/bin/entrypoint.sh\n")
	b.WriteString("RUN chmod 755 /usr/local/bin/entrypoint.sh\n\n")

	// Switch to non-root user
	b.WriteString("# Switch to non-root user\n")
	b.WriteString("USER ubuntu\n")
	b.WriteString("WORKDIR /home/ubuntu\n\n")

	// Run as user commands
	for _, s := range snippets {
		if s.RunAsUser != "" {
			b.WriteString(fmt.Sprintf("# %s setup (user)\n", s.Name))
			// Use heredoc syntax for complex shell scripts
			b.WriteString("RUN <<'EOF'\n")
			b.WriteString("set -e\n")
			b.WriteString(strings.TrimSpace(s.RunAsUser))
			b.WriteString("\nEOF\n\n")
		}
	}

	// Environment variables
	envVars := collectEnvVars(snippets)
	if len(envVars) > 0 {
		b.WriteString("# Environment variables\n")
		for key, value := range envVars {
			b.WriteString(fmt.Sprintf("ENV %s=%s\n", key, value))
		}
		b.WriteString("\n")
	}

	// PATH
	b.WriteString("# Ensure local binaries are in PATH\n")
	b.WriteString("ENV PATH=\"/home/ubuntu/.local/bin:/usr/local/bin:$PATH\"\n\n")

	// Working directory
	b.WriteString("# Set working directory for mounted projects\n")
	b.WriteString("WORKDIR /workspace\n\n")

	// Entrypoint and default command
	b.WriteString("# Use entrypoint to fix permissions on mounted volumes\n")
	b.WriteString("ENTRYPOINT [\"/usr/local/bin/entrypoint.sh\"]\n")

	// Determine default shell
	defaultShell := determineDefaultShell(snippets)
	b.WriteString(fmt.Sprintf("CMD [\"%s\"]\n", defaultShell))

	return b.String(), nil
}

// collectAptRepos gathers unique apt repos from all snippets
func collectAptRepos(snippets []*snippet.Snippet) []string {
	seen := make(map[string]bool)
	var result []string
	for _, s := range snippets {
		for _, repo := range s.AptRepos {
			if !seen[repo] {
				seen[repo] = true
				result = append(result, repo)
			}
		}
	}
	return result
}

// collectAptPackages gathers unique apt packages from all snippets
func collectAptPackages(snippets []*snippet.Snippet) []string {
	seen := make(map[string]bool)
	var result []string
	for _, s := range snippets {
		for _, pkg := range s.AptPackages {
			if !seen[pkg] {
				seen[pkg] = true
				result = append(result, pkg)
			}
		}
	}
	return result
}

// collectEnvVars gathers environment variables, later snippets override earlier
func collectEnvVars(snippets []*snippet.Snippet) map[string]string {
	result := make(map[string]string)
	for _, s := range snippets {
		for k, v := range s.Env {
			result[k] = v
		}
	}
	return result
}

// determineDefaultShell finds the last shell specified by snippets
func determineDefaultShell(snippets []*snippet.Snippet) string {
	shell := "bash" // default
	for _, s := range snippets {
		if s.UserShell != "" {
			shell = s.UserShell
		}
	}
	return shell
}
