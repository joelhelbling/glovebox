package generator

import (
	"fmt"
	"strings"

	"github.com/joelhelbling/glovebox/internal/assets"
	"github.com/joelhelbling/glovebox/internal/snippet"
)

// GenerateBase creates a base Dockerfile from a list of snippet IDs.
// This is used for the global profile and produces a standalone image.
func GenerateBase(snippetIDs []string) (string, error) {
	allSnippets, err := snippet.LoadMultiple(snippetIDs)
	if err != nil {
		return "", fmt.Errorf("loading snippets: %w", err)
	}

	// Separate build-time and post-install snippets
	snippets := filterBuildTimeSnippets(allSnippets)
	postInstallSnippets := filterPostInstallSnippets(allSnippets)

	var b strings.Builder

	// Header
	b.WriteString("# Generated by glovebox - DO NOT EDIT DIRECTLY\n")
	b.WriteString("#\n")
	b.WriteString("# This is the base image. To modify:\n")
	b.WriteString("#   glovebox add <snippet>      Add a snippet\n")
	b.WriteString("#   glovebox remove <snippet>   Remove a snippet\n")
	b.WriteString("#   glovebox build              Regenerate this file\n")
	b.WriteString("#\n")
	b.WriteString("# Build-time snippets:\n")
	for _, s := range snippets {
		b.WriteString(fmt.Sprintf("#   - %s\n", s.Name))
	}
	if len(postInstallSnippets) > 0 {
		b.WriteString("#\n")
		b.WriteString("# Post-install snippets (installed on first run):\n")
		for _, s := range postInstallSnippets {
			b.WriteString(fmt.Sprintf("#   - %s\n", s.Name))
		}
	}
	b.WriteString("\n")

	// Base image
	b.WriteString("FROM ubuntu:24.04\n\n")

	// Avoid interactive prompts
	b.WriteString("# Avoid interactive prompts during package installation\n")
	b.WriteString("ENV DEBIAN_FRONTEND=noninteractive\n\n")

	// Collect and dedupe apt repos
	aptRepos := collectAptRepos(snippets)
	if len(aptRepos) > 0 {
		// Need software-properties-common for apt-add-repository
		b.WriteString("# Install software-properties-common for apt-add-repository\n")
		b.WriteString("RUN apt-get update && apt-get install -y software-properties-common && rm -rf /var/lib/apt/lists/*\n\n")

		b.WriteString("# Add APT repositories\n")
		b.WriteString("RUN ")
		for i, repo := range aptRepos {
			if i > 0 {
				b.WriteString(" && \\\n    ")
			}
			b.WriteString(fmt.Sprintf("apt-add-repository %s", repo))
		}
		b.WriteString("\n\n")
	}

	// Collect and dedupe apt packages
	aptPackages := collectAptPackages(snippets)
	if len(aptPackages) > 0 {
		b.WriteString("# Install packages\n")
		b.WriteString("RUN apt-get update && apt-get install -y \\\n")
		for i, pkg := range aptPackages {
			b.WriteString(fmt.Sprintf("    %s", pkg))
			if i < len(aptPackages)-1 {
				b.WriteString(" \\\n")
			} else {
				b.WriteString(" \\\n    && rm -rf /var/lib/apt/lists/*\n")
			}
		}
		b.WriteString("\n")
	}

	// Run as root commands (in snippet order)
	for _, s := range snippets {
		if s.RunAsRoot != "" {
			b.WriteString(fmt.Sprintf("# %s setup (root)\n", s.Name))
			b.WriteString("RUN <<'EOF'\n")
			b.WriteString("set -e\n")
			b.WriteString(strings.TrimSpace(s.RunAsRoot))
			b.WriteString("\nEOF\n\n")
		}
	}

	// Write entrypoint script inline using heredoc
	b.WriteString("# Create entrypoint script\n")
	b.WriteString("RUN cat > /usr/local/bin/entrypoint.sh <<'EOF'\n")
	b.WriteString(strings.TrimSpace(assets.EntrypointScript))
	b.WriteString("\nEOF\n")
	b.WriteString("RUN chmod 755 /usr/local/bin/entrypoint.sh\n\n")

	// Create post-install script directory and script
	b.WriteString("# Create post-install script for first-run provisioning\n")
	b.WriteString("RUN mkdir -p /usr/local/lib/glovebox\n")
	postInstallScript := GeneratePostInstallScript(allSnippets)
	b.WriteString("RUN cat > /usr/local/lib/glovebox/post-install.sh <<'EOF'\n")
	b.WriteString(postInstallScript)
	b.WriteString("EOF\n")
	b.WriteString("RUN chmod 755 /usr/local/lib/glovebox/post-install.sh\n\n")

	// Switch to non-root user
	b.WriteString("# Switch to non-root user\n")
	b.WriteString("USER ubuntu\n")
	b.WriteString("WORKDIR /home/ubuntu\n\n")

	// Run as user commands
	for _, s := range snippets {
		if s.RunAsUser != "" {
			b.WriteString(fmt.Sprintf("# %s setup (user)\n", s.Name))
			b.WriteString("RUN <<'EOF'\n")
			b.WriteString("set -e\n")
			b.WriteString(strings.TrimSpace(s.RunAsUser))
			b.WriteString("\nEOF\n\n")
		}
	}

	// Environment variables
	envVars := collectEnvVars(snippets)
	if len(envVars) > 0 {
		b.WriteString("# Environment variables\n")
		for key, value := range envVars {
			b.WriteString(fmt.Sprintf("ENV %s=%s\n", key, value))
		}
		b.WriteString("\n")
	}

	// PATH
	b.WriteString("# Ensure local binaries are in PATH\n")
	b.WriteString("ENV PATH=\"/home/ubuntu/.local/bin:/usr/local/bin:$PATH\"\n\n")

	// Working directory
	b.WriteString("# Set working directory for mounted projects\n")
	b.WriteString("WORKDIR /workspace\n\n")

	// Entrypoint and default command
	b.WriteString("# Use entrypoint to fix permissions on mounted volumes\n")
	b.WriteString("ENTRYPOINT [\"/usr/local/bin/entrypoint.sh\"]\n")

	// Determine default shell
	defaultShell := determineDefaultShell(snippets)
	b.WriteString(fmt.Sprintf("CMD [\"%s\"]\n", defaultShell))

	return b.String(), nil
}

// GenerateProject creates a project Dockerfile that extends the base image.
// It only includes project-specific snippets (additive to base).
// baseSnippetIDs should contain the snippets already installed in the base image,
// so their dependencies won't be redundantly included.
func GenerateProject(snippetIDs []string, baseSnippetIDs []string) (string, error) {
	allSnippets, err := snippet.LoadMultipleExcluding(snippetIDs, baseSnippetIDs)
	if err != nil {
		return "", fmt.Errorf("loading snippets: %w", err)
	}

	// Separate build-time and post-install snippets
	snippets := filterBuildTimeSnippets(allSnippets)
	postInstallSnippets := filterPostInstallSnippets(allSnippets)

	var b strings.Builder

	// Header
	b.WriteString("# Generated by glovebox - DO NOT EDIT DIRECTLY\n")
	b.WriteString("#\n")
	b.WriteString("# This extends glovebox:base with project-specific tools.\n")
	b.WriteString("# To modify:\n")
	b.WriteString("#   glovebox add <snippet>      Add a snippet\n")
	b.WriteString("#   glovebox remove <snippet>   Remove a snippet\n")
	b.WriteString("#   glovebox build              Regenerate this file\n")
	b.WriteString("#\n")
	if len(snippets) > 0 {
		b.WriteString("# Build-time snippets:\n")
		for _, s := range snippets {
			b.WriteString(fmt.Sprintf("#   - %s\n", s.Name))
		}
	}
	if len(postInstallSnippets) > 0 {
		if len(snippets) > 0 {
			b.WriteString("#\n")
		}
		b.WriteString("# Post-install snippets (installed on first run):\n")
		for _, s := range postInstallSnippets {
			b.WriteString(fmt.Sprintf("#   - %s\n", s.Name))
		}
	}
	if len(snippets) == 0 && len(postInstallSnippets) == 0 {
		b.WriteString("# (no project-specific snippets)\n")
	}
	b.WriteString("\n")

	// Extend base image
	b.WriteString("FROM glovebox:base\n\n")

	// Switch to root for installations
	b.WriteString("USER root\n\n")

	// Collect and dedupe apt repos
	aptRepos := collectAptRepos(snippets)
	if len(aptRepos) > 0 {
		// Need software-properties-common for apt-add-repository (may already be in base)
		b.WriteString("# Ensure software-properties-common is available for apt-add-repository\n")
		b.WriteString("RUN apt-get update && apt-get install -y software-properties-common && rm -rf /var/lib/apt/lists/*\n\n")

		b.WriteString("# Add APT repositories\n")
		b.WriteString("RUN ")
		for i, repo := range aptRepos {
			if i > 0 {
				b.WriteString(" && \\\n    ")
			}
			b.WriteString(fmt.Sprintf("apt-add-repository %s", repo))
		}
		b.WriteString("\n\n")
	}

	// Collect and dedupe apt packages
	aptPackages := collectAptPackages(snippets)
	if len(aptPackages) > 0 {
		b.WriteString("# Install packages\n")
		b.WriteString("RUN apt-get update && apt-get install -y \\\n")
		for i, pkg := range aptPackages {
			b.WriteString(fmt.Sprintf("    %s", pkg))
			if i < len(aptPackages)-1 {
				b.WriteString(" \\\n")
			} else {
				b.WriteString(" \\\n    && rm -rf /var/lib/apt/lists/*\n")
			}
		}
		b.WriteString("\n")
	}

	// Run as root commands (in snippet order)
	for _, s := range snippets {
		if s.RunAsRoot != "" {
			b.WriteString(fmt.Sprintf("# %s setup (root)\n", s.Name))
			b.WriteString("RUN <<'EOF'\n")
			b.WriteString("set -e\n")
			b.WriteString(strings.TrimSpace(s.RunAsRoot))
			b.WriteString("\nEOF\n\n")
		}
	}

	// Switch back to non-root user
	b.WriteString("# Switch back to non-root user\n")
	b.WriteString("USER ubuntu\n")
	b.WriteString("WORKDIR /home/ubuntu\n\n")

	// Run as user commands
	for _, s := range snippets {
		if s.RunAsUser != "" {
			b.WriteString(fmt.Sprintf("# %s setup (user)\n", s.Name))
			b.WriteString("RUN <<'EOF'\n")
			b.WriteString("set -e\n")
			b.WriteString(strings.TrimSpace(s.RunAsUser))
			b.WriteString("\nEOF\n\n")
		}
	}

	// Environment variables
	envVars := collectEnvVars(snippets)
	if len(envVars) > 0 {
		b.WriteString("# Environment variables\n")
		for key, value := range envVars {
			b.WriteString(fmt.Sprintf("ENV %s=%s\n", key, value))
		}
		b.WriteString("\n")
	}

	// Update post-install script if there are project-specific post-install snippets
	if len(postInstallSnippets) > 0 {
		b.WriteString("# Update post-install script with project-specific snippets\n")
		b.WriteString("USER root\n")
		postInstallScript := GeneratePostInstallScript(allSnippets)
		b.WriteString("RUN cat > /usr/local/lib/glovebox/post-install.sh <<'EOF'\n")
		b.WriteString(postInstallScript)
		b.WriteString("EOF\n")
		b.WriteString("RUN chmod 755 /usr/local/lib/glovebox/post-install.sh\n")
		b.WriteString("USER ubuntu\n\n")
	}

	// Set working directory
	b.WriteString("# Set working directory for mounted projects\n")
	b.WriteString("WORKDIR /workspace\n")

	return b.String(), nil
}

// Generate creates a Dockerfile from a list of snippet IDs (legacy, for base images)
// Deprecated: Use GenerateBase or GenerateProject instead
func Generate(snippetIDs []string) (string, error) {
	return GenerateBase(snippetIDs)
}

// collectAptRepos gathers unique apt repos from all snippets
func collectAptRepos(snippets []*snippet.Snippet) []string {
	seen := make(map[string]bool)
	var result []string
	for _, s := range snippets {
		for _, repo := range s.AptRepos {
			if !seen[repo] {
				seen[repo] = true
				result = append(result, repo)
			}
		}
	}
	return result
}

// collectAptPackages gathers unique apt packages from all snippets
func collectAptPackages(snippets []*snippet.Snippet) []string {
	seen := make(map[string]bool)
	var result []string
	for _, s := range snippets {
		for _, pkg := range s.AptPackages {
			if !seen[pkg] {
				seen[pkg] = true
				result = append(result, pkg)
			}
		}
	}
	return result
}

// collectEnvVars gathers environment variables, later snippets override earlier
func collectEnvVars(snippets []*snippet.Snippet) map[string]string {
	result := make(map[string]string)
	for _, s := range snippets {
		for k, v := range s.Env {
			result[k] = v
		}
	}
	return result
}

// determineDefaultShell finds the last shell specified by snippets
func determineDefaultShell(snippets []*snippet.Snippet) string {
	shell := "bash" // default
	for _, s := range snippets {
		if s.UserShell != "" {
			shell = s.UserShell
		}
	}
	return shell
}

// filterBuildTimeSnippets returns only snippets that should be installed during docker build
func filterBuildTimeSnippets(snippets []*snippet.Snippet) []*snippet.Snippet {
	var result []*snippet.Snippet
	for _, s := range snippets {
		if s.IsBuildTime() {
			result = append(result, s)
		}
	}
	return result
}

// filterPostInstallSnippets returns only snippets that should be installed on first run
func filterPostInstallSnippets(snippets []*snippet.Snippet) []*snippet.Snippet {
	var result []*snippet.Snippet
	for _, s := range snippets {
		if s.IsPostInstall() {
			result = append(result, s)
		}
	}
	return result
}

// GeneratePostInstallScript creates a shell script for first-run installation
func GeneratePostInstallScript(snippets []*snippet.Snippet) string {
	postInstallSnippets := filterPostInstallSnippets(snippets)

	var b strings.Builder

	b.WriteString("#!/bin/bash\n")
	b.WriteString("set -e\n\n")

	if len(postInstallSnippets) == 0 {
		b.WriteString("# No post-install snippets configured\n")
		b.WriteString("exit 0\n")
		return b.String()
	}

	b.WriteString("echo \"\"\n")
	b.WriteString("echo \"===========================================\"\n")
	b.WriteString("echo \"Glovebox: First-run provisioning\"\n")
	b.WriteString("echo \"===========================================\"\n")
	b.WriteString("echo \"\"\n")
	b.WriteString("echo \"Installing tools you selected. This only\"\n")
	b.WriteString("echo \"happens on first run - subsequent starts\"\n")
	b.WriteString("echo \"will be instant.\"\n")
	b.WriteString("echo \"\"\n\n")

	total := len(postInstallSnippets)
	for i, s := range postInstallSnippets {
		b.WriteString(fmt.Sprintf("# %s\n", s.Name))
		b.WriteString(fmt.Sprintf("echo \"[%d/%d] Installing %s...\"\n", i+1, total, s.Name))

		if s.RunAsRoot != "" {
			b.WriteString("sudo bash <<'ROOTEOF'\n")
			b.WriteString("set -e\n")
			b.WriteString(strings.TrimSpace(s.RunAsRoot))
			b.WriteString("\nROOTEOF\n\n")
		}

		if s.RunAsUser != "" {
			b.WriteString(strings.TrimSpace(s.RunAsUser))
			b.WriteString("\n\n")
		}
	}

	b.WriteString("echo \"\"\n")
	b.WriteString("echo \"===========================================\"\n")
	b.WriteString("echo \"Provisioning complete!\"\n")
	b.WriteString("echo \"===========================================\"\n")
	b.WriteString("echo \"\"\n")

	return b.String()
}
